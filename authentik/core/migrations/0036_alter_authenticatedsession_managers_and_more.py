# Generated by Django 5.0.6 on 2024-05-15 11:17

import django.db.models.deletion
from django.apps.registry import Apps
from django.conf import settings
from django.db import migrations, models
from django.db.backends.base.schema import BaseDatabaseSchemaEditor

import authentik.core.models


def migrate_sessions(apps: Apps, schema_editor: BaseDatabaseSchemaEditor):
    from django.contrib.sessions.backends.cache import KEY_PREFIX
    from django.core.cache import cache

    AuthenticatedSession = apps.get_model("authentik_core", "AuthenticatedSession")
    DjangoSession = apps.get_model("sessions", "Session")
    db_alias = schema_editor.connection.alias

    session_keys = cache.keys(KEY_PREFIX + "*")
    for key, data in cache.get_many(session_keys).items():
        AuthenticatedSession.objects.using(db_alias).filter(session_key=key).update(
            session_data=data
        )
    cache.delete_many(session_keys)
    for session in DjangoSession.objects.using(db_alias).all():
        AuthenticatedSession.objects.using(db_alias).filter(session_key=session.session_key).update(
            session_data=session.session_data
        )
    DjangoSession.objects.using(db_alias).delete()


class Migration(migrations.Migration):

    dependencies = [
        ("authentik_core", "0035_alter_group_options_and_more"),
    ]

    operations = [
        migrations.AlterModelManagers(
            name="authenticatedsession",
            managers=[
                ("objects", authentik.core.models.AuthenticatedSessionManager()),
            ],
        ),
        migrations.AddField(
            model_name="authenticatedsession",
            name="session_data",
            field=models.TextField(default="", verbose_name="session data"),
            preserve_default=False,
        ),
        migrations.AlterField(
            model_name="authenticatedsession",
            name="expires",
            field=models.DateTimeField(db_index=True, default=None, null=True),
        ),
        migrations.AlterField(
            model_name="authenticatedsession",
            name="expiring",
            field=models.BooleanField(db_index=True, default=True),
        ),
        migrations.AlterField(
            model_name="authenticatedsession",
            name="last_ip",
            field=models.TextField(blank=True),
        ),
        migrations.AlterField(
            model_name="authenticatedsession",
            name="session_key",
            field=models.CharField(
                db_index=True, max_length=40, unique=True, verbose_name="session key"
            ),
        ),
        migrations.AlterField(
            model_name="authenticatedsession",
            name="user",
            field=models.ForeignKey(
                null=True, on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL
            ),
        ),
        migrations.AlterField(
            model_name="token",
            name="expires",
            field=models.DateTimeField(db_index=True, default=None, null=True),
        ),
        migrations.AlterField(
            model_name="token",
            name="expiring",
            field=models.BooleanField(db_index=True, default=True),
        ),
        migrations.RunPython(migrate_sessions),
    ]
